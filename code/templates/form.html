<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>WanderIA ‚Äì Connexion</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/form.css') }}"/>
</head>
<body>
  <!-- Conteneur pour la vid√©o YouTube (l'API YouTube cr√©era le player ici) -->
  <div id="background-video" class="video-container"></div>
  
  <!-- Iframe de fallback (cach√©e si l'API YouTube fonctionne) -->
  <iframe
    id="background-video-fallback"
    class="video-fallback"
    src="https://www.youtube.com/embed/ZsJz2TJAPjw?autoplay=1&mute=1&loop=1&playlist=ZsJz2TJAPjw&controls=0&playsinline=1&enablejsapi=1&rel=0&modestbranding=1&iv_load_policy=3"
    frameborder="0"
    title="Vid√©o de fond"
    allow="autoplay; encrypted-media; fullscreen; accelerometer; gyroscope; picture-in-picture"
    allowfullscreen
    loading="eager"
  ></iframe>
  
  <!-- Bouton de contr√¥le audio -->
  <button id="audio-toggle" class="audio-control" title="Activer/D√©sactiver le son">
    <span id="audio-icon">üîá</span>
  </button>
  
  <div class="container">
    <div class="tabs">
      <button id="loginTab" class="active">Se connecter</button>
      <button id="registerTab">Cr√©er un compte</button>
    </div>

    <!-- Login -->
    <form id="loginForm" class="form active" autocomplete="on" method="post" action="{{ url_for('login') }}">
      <input id="loginEmail" name="email" type="email" placeholder="Email" required />
      <input id="loginPassword" name="password" type="password" placeholder="Mot de passe" required />
      <a href="#" class="forgot-link">Mot de passe oubli√© ?</a>
      <button type="submit" class="btn">Connexion</button>
      {% if error_login %}
      <p class="error">{{ error_login }}</p>
      {% endif %}
      <p class="or">Ou continuez avec</p>
      <div class="socials">
        <button type="button" class="social">G</button>
        <button type="button" class="social">f</button>
        <button type="button" class="social">t</button>
      </div>
    </form>

    <!-- Register -->
    <form id="registerForm" class="form" autocomplete="on" method="post" action="{{ url_for('signup') }}">
      <input id="regName" name="name" type="text" placeholder="Nom complet" required />
      <input id="regEmail" name="email" type="email" placeholder="Email" required />
      <input id="regPassword" name="password" type="password" placeholder="Mot de passe" required />
      <input id="regConfirm" name="confirm_password" type="password" placeholder="Confirmez le mot de passe" required />
      <button type="submit" class="btn">S'inscrire</button>
      {% if error_signup %}
      <p class="error">{{ error_signup }}</p>
      {% endif %}
      <p class="or">Ou inscrivez-vous avec</p>
      <div class="socials">
        <button type="button" class="social">G</button>
        <button type="button" class="social">f</button>
        <button type="button" class="social">t</button>
      </div>
    </form>
  </div>

  <!-- JS onglets (plus de mock d'auth, tout passe c√¥t√© Flask) -->
  <script src="{{ url_for('static', filename='js/form.js') }}"></script>
  
  <!-- Script pour forcer la lecture de la vid√©o YouTube -->
  <script>
    // Charger l'API YouTube pour un meilleur contr√¥le
    var tag = document.createElement('script');
    tag.src = "https://www.youtube.com/iframe_api";
    var firstScriptTag = document.getElementsByTagName('script')[0];
    firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);

    var player;
    var isMuted = true; // √âtat initial : muet
    
    function onYouTubeIframeAPIReady() {
      var container = document.getElementById('background-video');
      var fallback = document.getElementById('background-video-fallback');
      
      if (container) {
        try {
          player = new YT.Player('background-video', {
            videoId: 'ZsJz2TJAPjw',
            playerVars: {
              'autoplay': 1,
              'mute': 1,
              'loop': 1,
              'playlist': 'ZsJz2TJAPjw',
              'controls': 0,
              'playsinline': 1,
              'modestbranding': 1,
              'rel': 0,
              'iv_load_policy': 3,
              'showinfo': 0
            },
            events: {
              'onReady': function(event) {
                try {
                  event.target.playVideo();
                  event.target.setVolume(0); // D√©marrer muet
                  // Cacher l'iframe de fallback si le player fonctionne
                  if (fallback) {
                    fallback.style.display = 'none';
                  }
                  // Forcer la lecture apr√®s un court d√©lai
                  setTimeout(function() {
                    if (event.target && typeof event.target.playVideo === 'function') {
                      var state = event.target.getPlayerState();
                      if (state !== YT.PlayerState.PLAYING && state !== YT.PlayerState.BUFFERING) {
                        event.target.playVideo();
                      }
                    }
                  }, 1000);
                } catch(e) {
                  console.log('Erreur lors du d√©marrage de la vid√©o:', e);
                  // Afficher le fallback en cas d'erreur
                  if (fallback) {
                    fallback.style.display = 'block';
                  }
                }
              },
              'onStateChange': function(event) {
                if (event.data === YT.PlayerState.ENDED) {
                  event.target.playVideo();
                }
                // Relancer si mise en pause
                if (event.data === YT.PlayerState.PAUSED) {
                  setTimeout(function() {
                    if (event.target && typeof event.target.playVideo === 'function') {
                      event.target.playVideo();
                    }
                  }, 200);
                }
              },
              'onError': function(event) {
                console.log('Erreur YouTube player:', event.data);
                // Afficher le fallback en cas d'erreur
                if (fallback) {
                  fallback.style.display = 'block';
                }
              }
            }
          });
        } catch(e) {
          console.log('Erreur lors de la cr√©ation du player YouTube:', e);
          // Afficher le fallback en cas d'erreur
          if (fallback) {
            fallback.style.display = 'block';
          }
        }
      }
    }

    // Fallback : s'assurer que la vid√©o se charge m√™me sans l'API YouTube
    window.addEventListener('load', function() {
      setTimeout(function() {
        // Si l'API YouTube n'a pas cr√©√© le player apr√®s 3 secondes, utiliser l'iframe
        if (!player) {
          var fallback = document.getElementById('background-video-fallback');
          if (fallback) {
            fallback.style.display = 'block';
            console.log('Utilisation de l\'iframe de fallback (API YouTube non disponible)');
          }
        }
      }, 3000);
    });

    // Gestion du bouton audio
    function toggleAudio() {
      if (!player) {
        // Si l'API YouTube n'est pas disponible, on ne peut pas contr√¥ler l'audio
        alert('Le contr√¥le audio n√©cessite l\'API YouTube. Veuillez actualiser la page.');
        return;
      }
      
      try {
        if (isMuted) {
          // Activer le son
          player.unMute();
          player.setVolume(70); // Volume √† 70%
          isMuted = false;
          document.getElementById('audio-icon').textContent = 'üîä';
          document.getElementById('audio-toggle').title = 'D√©sactiver le son';
        } else {
          // D√©sactiver le son
          player.mute();
          isMuted = true;
          document.getElementById('audio-icon').textContent = 'üîá';
          document.getElementById('audio-toggle').title = 'Activer le son';
        }
      } catch(e) {
        console.log('Erreur lors du changement de volume:', e);
      }
    }
    
    // Ajouter l'√©v√©nement au bouton audio
    document.addEventListener('DOMContentLoaded', function() {
      var audioToggle = document.getElementById('audio-toggle');
      if (audioToggle) {
        audioToggle.addEventListener('click', function(e) {
          e.preventDefault();
          e.stopPropagation();
          toggleAudio();
        });
      }
    });

    // Interaction utilisateur pour d√©bloquer l'autoplay
    document.addEventListener('click', function() {
      if (player && typeof player.playVideo === 'function') {
        try {
          var state = player.getPlayerState();
          if (state !== YT.PlayerState.PLAYING) {
            player.playVideo();
          }
        } catch(e) {
          console.log('Erreur lors de la lecture apr√®s clic:', e);
        }
      }
    }, { once: true });
  </script>
</body>
</html>